<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>구룡투: 흑과 백</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&display=swap" rel="stylesheet">

    <style>
        /* 폰트 강제 적용 */
        * {
            font-family: 'Nanum Myeongjo', 'Gungsuh', serif !important;
        }

        body { 
            background-color: #e0f7fa; 
            color: #333; 
            margin: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
            user-select: none;
        }

        /* --- [엔딩 애니메이션] --- */
        #ending-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            flex-direction: column;
            justify-content: center; align-items: center;
            animation: fadeIn 0.5s forwards;
        }

        .glow-text {
            font-size: 80px; font-weight: 800; color: #ffd700;
            text-shadow: 0 0 20px #ff6f00, 0 0 40px #ff6f00;
            animation: heartbeat 1.5s infinite;
            margin-bottom: 30px;
            white-space: nowrap;
        }

        /* 복기하기 버튼 스타일 */
        .review-btn {
            padding: 15px 40px; font-size: 24px; background: white; color: black;
            border: none; border-radius: 50px; cursor: pointer; font-weight: bold;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            transition: transform 0.2s;
        }
        .review-btn:hover { transform: scale(1.1); }

        /* [추가] 복기 모드일 때 하단에 뜨는 재시작 버튼 패널 */
        #review-controls {
            display: none; /* 평소엔 숨김 */
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1500;
        }
        .restart-fixed-btn {
            background: #333; color: white; border: 2px solid #fff;
            padding: 10px 30px; font-size: 20px; border-radius: 30px; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            font-weight: bold;
        }
        .restart-fixed-btn:hover { background: #555; transform: scale(1.05); }

        @keyframes heartbeat {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); text-shadow: 0 0 30px #ffca28, 0 0 60px #ffca28; }
            100% { transform: scale(1); }
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- 대기실 --- */
        #lobby { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 40px; border-radius: 10px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 1000; border: 2px solid #333;
            min-width: 320px;
        }
        .start-btn {
            background: #333; color: white;
            border: 1px solid #000; padding: 12px 30px; font-size: 22px; cursor: pointer; margin-top: 20px; width: 100%;
        }
        .start-btn:hover { background: #555; }
        #host-controls label {
            font-size: 20px; font-weight: bold; color: #333; display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-top: 15px; cursor: pointer;
        }
        input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }

        /* --- 게임 레이아웃 --- */
        #game-container {
            display: none; 
            flex-direction: column; height: 100%; justify-content: space-between; padding: 20px;
            box-sizing: border-box; align-items: center;
        }

        /* 상단: 상대방 패 */
        #opponent-area {
            display: flex; gap: 5px; padding: 10px;
            background: rgba(0,0,0,0.05); border-radius: 10px;
            min-height: 80px; align-items: center;
        }

        /* 중앙: 보드판 */
        #board-wrapper {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; max-width: 1100px;
            position: relative; margin: 10px 0;
            flex-grow: 1; 
        }

        .action-zone {
            height: 100px; width: 100%;
            display: flex; justify-content: center; align-items: center;
            margin: 5px 0;
        }

        /* 메인 트랙 */
        #main-track {
            display: flex; align-items: center;
            background: #4e342e; /* 짙은 갈색 */
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.6);
            border: 4px solid #3e2723;
            gap: 8px;
        }

        /* 트랙 슬롯 */
        .track-slot {
            width: 70px; height: 180px; 
            background: #3e2723; 
            border: 2px inset #2d1b18;
            border-radius: 5px;
            display: flex; justify-content: center; 
            align-items: center;
            flex-direction: column;
            position: relative;
            padding: 5px 0;
            gap: 15px; 
        }

        /* 중앙 구분선 */
        .track-slot::after {
            content: '';
            position: absolute;
            top: 50%; left: 0; width: 100%; height: 8px; 
            background-color: #2d1b18; 
            border-top: 1px solid rgba(0,0,0,0.6);
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            transform: translateY(-50%);
            z-index: 0;
        }
        
        .slot-number {
            position: absolute; font-size: 14px; color: #8d6e63; top: 50%; transform: translateY(-50%); z-index: 1;
            background: #3e2723; padding: 2px 6px; border-radius: 4px; border: 1px solid #2d1b18;
            font-weight: bold;
        }

        /* 점수판 */
        #score-panel {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: #212121; color: white;
            width: 90px; height: 180px; 
            border: 2px solid #666; border-radius: 5px;
            margin-left: 10px;
        }
        .score-row { display: flex; flex-direction: column; align-items: center; font-size: 16px; margin: 10px 0; }
        .score-val { font-size: 32px; font-weight: 800; line-height: 1; }
        .score-op { color: #ff5252; } 
        .score-my { color: #448aff; } 

        /* 하단: 내 패 */
        #my-area {
            display: flex; flex-direction: column; align-items: center;
            background: rgba(255,255,255,0.6); padding: 15px; border-radius: 15px;
            width: 100%; max-width: 800px;
            transition: opacity 0.3s;
        }
        #my-area.locked { opacity: 0.5; filter: grayscale(0.5); }

        #my-cards-container { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; justify-content: center;}

        /* --- 카드 디자인 --- */
        .card {
            width: 60px; height: 90px; border-radius: 6px; 
            font-size: 36px; font-weight: 800;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.4); border: 2px solid #000;
            position: relative; cursor: pointer;
            transition: transform 0.2s;
            z-index: 10;
        }
        .card.face-up:hover { transform: translateY(-15px); }
        .card.disabled { opacity: 0.5; cursor: not-allowed; transform: none !important;}

        .card.black { background: #000; color: #fff; border: 2px solid #aaa; }
        .card.white { background: #fff; color: #000; border: 2px solid #333; }

        .card.opponent-card { color: transparent; font-size: 0; }
        .card.opponent-card.black { background: repeating-linear-gradient(45deg, #111, #111 10px, #222 10px, #222 20px); }
        .card.opponent-card.white { background: repeating-linear-gradient(45deg, #fff, #fff 10px, #eee 10px, #eee 20px); }

        /* 결과 타일 */
        .tracked-card {
            width: 55px; height: 75px; font-size: 24px; font-weight: 800;
            border-radius: 4px; display: flex; justify-content: center; align-items: center;
            box-shadow: 1px 1px 4px rgba(0,0,0,0.5);
            position: relative;
            z-index: 2; 
        }
        .tracked-card.black { background: #000; color: white; border: 1px solid #999; }
        .tracked-card.white { background: #fff; color: black; border: 1px solid #333; }
        .tracked-card.opponent-card { color: transparent; }

        .winner-glow {
            box-shadow: 0 0 15px 5px rgba(255, 215, 0, 0.8) !important;
            border-color: #ffd700 !important;
        }

        /* 승패 텍스트 */
        .result-text {
            position: absolute;
            font-size: 13px; font-weight: 900;
            width: 100%; text-align: center;
            text-shadow: 1px 1px 0px #000;
            z-index: 100;
            left: 0;
            line-height: 1;
        }
        .result-text.top { top: 1px; } 
        .result-text.bottom { bottom: 1px; }

        .text-win-my { color: #2979ff; } 
        .text-win-op { color: #ff1744; } 
        .text-draw { color: #9e9e9e; } 

        #turn-indicator { 
            padding: 8px 30px; border-radius: 30px; color: white; font-size: 20px; margin-bottom: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-weight: bold;
        }

        /* 애니메이션 */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shaking { animation: shake 0.5s infinite; }
        @keyframes pop { from{transform:scale(0.5); opacity:0;} to{transform:scale(1); opacity:1;} }
        .pop-in { animation: pop 0.3s forwards; }

    </style>
</head>
<body>

    <div id="ending-overlay">
        <div class="glow-text">좋승좋승</div>
        <button class="review-btn" onclick="startReview()">복기하기</button>
    </div>

    <div id="review-controls">
        <button class="restart-fixed-btn" onclick="location.reload()">새 게임 시작</button>
    </div>

    <div id="lobby">
        <h1 style="font-size: 40px; margin-bottom: 10px;">구룡투: 흑과 백</h1>
        <p id="player-count" style="color: #666; font-size: 18px;">접속자 대기 중...</p>
        
        <div id="host-controls" style="display:none;">
            <label>
                <input type="checkbox" id="chk-carryover" checked> 
                <span>무승부 점수 이월</span>
            </label>
            <button class="start-btn" onclick="startGame()">게임 시작</button>
        </div>
    </div>

    <div id="game-container">
        
        <div>
            <div style="text-align: center; font-size: 18px; margin-bottom: 5px; color:#555; font-weight:bold;">상대방</div>
            <div id="opponent-area"></div>
        </div>

        <div id="board-wrapper">
            
            <div class="action-zone" id="az-opponent"></div>

            <div id="main-track">
                <div id="track-slots-container" style="display:flex; gap:8px;"></div>

                <div id="score-panel">
                    <div class="score-row score-op">
                        <span>敵</span> <span id="sc-op" class="score-val">0</span>
                    </div>
                    <div style="width:80%; height:2px; background:#444;"></div>
                    <div class="score-row score-my">
                        <span>我</span> <span id="sc-my" class="score-val">0</span>
                    </div>
                </div>
            </div>

            <div class="action-zone" id="az-my"></div>

        </div>

        <div id="my-area">
            <div id="turn-indicator">게임 대기 중</div>
            <div id="my-cards-container"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let mySocketId = null;
        let currentRoundIndex = 1;
        let isLocked = false; 

        const lobby = document.getElementById('lobby');
        const gameContainer = document.getElementById('game-container');
        const trackContainer = document.getElementById('track-slots-container');
        const azOp = document.getElementById('az-opponent');
        const azMy = document.getElementById('az-my');
        const turnInd = document.getElementById('turn-indicator');
        const scOp = document.getElementById('sc-op');
        const scMy = document.getElementById('sc-my');
        const myAreaDiv = document.getElementById('my-area'); 
        
        // 엔딩 관련 요소
        const endingOverlay = document.getElementById('ending-overlay');
        const reviewControls = document.getElementById('review-controls');

        // 슬롯 생성
        for(let i=1; i<=9; i++) {
            const slot = document.createElement('div');
            slot.className = 'track-slot';
            slot.id = `slot-${i}`;
            slot.innerHTML = `<span class="slot-number">${i}</span>`;
            trackContainer.appendChild(slot);
        }

        socket.on('connect', () => { mySocketId = socket.id; });

        socket.on('update_player_count', (cnt) => {
            document.getElementById('player-count').innerText = `현재 접속자: ${cnt} / 2명`;
        });

        socket.on('player_role', (data) => {
            if(data.isHost) document.getElementById('host-controls').style.display = 'block';
        });

        function startGame() {
            const carryover = document.getElementById('chk-carryover').checked;
            socket.emit('request_start_game', { carryover });
        }

        socket.on('game_start', (data) => {
            lobby.style.display = 'none';
            gameContainer.style.display = 'flex';
            endingOverlay.style.display = 'none';
            reviewControls.style.display = 'none'; // 새 게임 버튼 숨김
            currentRoundIndex = 1;
            isLocked = false; 

            azOp.innerHTML = ''; azMy.innerHTML = '';
            for(let i=1; i<=9; i++) {
                document.getElementById(`slot-${i}`).innerHTML = `<span class="slot-number">${i}</span>`;
            }
            updateScore(data.scores);
            setupCards(data.firstPlayer);
        });

        function setupCards(firstPlayer) {
            const opArea = document.getElementById('opponent-area');
            const myArea = document.getElementById('my-cards-container');
            
            opArea.innerHTML = '';
            myArea.innerHTML = '';

            for(let i=0; i<5; i++) createOpCard('white', opArea);
            for(let i=0; i<4; i++) createOpCard('black', opArea);

            for(let i=1; i<=9; i++) {
                const c = document.createElement('div');
                c.className = `card face-up ${i%2==0?'black':'white'}`;
                c.innerText = i;
                c.onclick = () => submitCard(i, c);
                myArea.appendChild(c);
            }
            setTurn(firstPlayer);
        }

        function createOpCard(color, parent) {
            const c = document.createElement('div');
            c.className = `card opponent-card ${color}`;
            parent.appendChild(c);
        }

        function setTurn(pid) {
            const myCards = document.querySelectorAll('#my-cards-container .card:not(.used)');
            
            if (pid === null || pid === mySocketId) {
                if (isLocked) {
                    turnInd.innerText = "결과 대기 중...";
                    turnInd.style.background = "#555";
                    return;
                }

                if(pid === null) {
                    turnInd.innerText = "전투 개시!";
                    turnInd.style.background = "#ff9800"; 
                } else {
                    turnInd.innerText = "나의 차례 (선)";
                    turnInd.style.background = "#2979ff"; 
                }
                myCards.forEach(c => { c.style.pointerEvents = 'auto'; c.classList.remove('disabled'); });
            } 
            else {
                turnInd.innerText = "상대방 차례 (후)";
                turnInd.style.background = "#ff5252"; 
                myCards.forEach(c => { c.style.pointerEvents = 'none'; c.classList.add('disabled'); });
            }
        }

        function submitCard(num, el) {
            if (isLocked) return;
            
            socket.emit('submit_card', num);
            isLocked = true;
            
            el.classList.add('used'); 
            el.style.display = 'none';

            const battleCard = document.createElement('div');
            battleCard.className = `card ${num%2==0?'black':'white'} pop-in`;
            battleCard.innerText = num;
            azMy.innerHTML = '';
            azMy.appendChild(battleCard);

            turnInd.innerText = "결과 대기 중...";
            turnInd.style.background = "#555";
            myAreaDiv.classList.add('locked');
        }

        socket.on('opponent_submitted', (data) => {
            const color = data.color.includes('흑') ? 'black' : 'white';
            const stack = document.querySelectorAll(`#opponent-area .${color}:not(.used)`);
            if(stack.length > 0) {
                stack[0].classList.add('used');
                stack[0].style.display = 'none';
            }

            const battleCard = document.createElement('div');
            battleCard.className = `card opponent-card ${color} pop-in`;
            azOp.innerHTML = '';
            azOp.appendChild(battleCard);

            if (!isLocked) {
                turnInd.innerText = "나의 차례!";
                turnInd.style.background = "#2979ff";
                const myCards = document.querySelectorAll('#my-cards-container .card:not(.used)');
                myCards.forEach(c => { c.style.pointerEvents = 'auto'; c.classList.remove('disabled'); });
            }
        });

        socket.on('round_result', (data) => {
            isLocked = true;
            myAreaDiv.classList.add('locked');

            const opId = Object.keys(data.cards).find(id => id !== mySocketId);
            const myCardNum = data.cards[mySocketId];
            const opCardNum = data.cards[opId];

            const myAzCard = azMy.querySelector('.card');
            const opAzCard = azOp.querySelector('.card');
            if(myAzCard) myAzCard.classList.add('shaking');
            if(opAzCard) opAzCard.classList.add('shaking');

            turnInd.innerText = "승부 확인 중...";
            turnInd.style.background = "#333";

            setTimeout(() => {
                if(myAzCard) myAzCard.classList.remove('shaking');
                if(opAzCard) opAzCard.classList.remove('shaking');

                const slot = document.getElementById(`slot-${currentRoundIndex}`);
                if(slot) {
                    slot.innerHTML = ''; 
                    
                    let winText = "";
                    let isMyWin = false;
                    let isOpWin = false;

                    if(data.winnerId === mySocketId) {
                        isMyWin = true;
                        winText = `<div class="result-text bottom text-win-my">WIN</div>`;
                    } else if(data.winnerId === opId) {
                        isOpWin = true;
                        winText = `<div class="result-text top text-win-op">WIN</div>`;
                    } else {
                        winText = `<div class="result-text top text-draw">DRAW</div><div class="result-text bottom text-draw">DRAW</div>`;
                    }

                    slot.innerHTML += winText;

                    const smallOp = createTrackedCard(opCardNum, false);
                    if(isOpWin) smallOp.classList.add('winner-glow');
                    
                    const smallMy = createTrackedCard(myCardNum, true);
                    if(isMyWin) smallMy.classList.add('winner-glow');

                    slot.appendChild(smallOp);
                    slot.appendChild(smallMy);
                }

                azMy.innerHTML = '';
                azOp.innerHTML = '';

                currentRoundIndex++;
                updateScore(data.scores);
                
                isLocked = false;
                myAreaDiv.classList.remove('locked');
                setTurn(data.firstPlayer);

                checkGameOver();

            }, 3000); 
        });

        function createTrackedCard(num, isMine) {
            const div = document.createElement('div');
            const color = num % 2 === 0 ? 'black' : 'white';
            div.className = `tracked-card ${color}`;
            if(isMine) {
                div.innerText = num; 
            } else {
                div.classList.add('opponent-card');
                div.dataset.hiddenNum = num; 
            }
            return div;
        }

        function updateScore(scores) {
            if (!scores) return; 
            const ids = Object.keys(scores);
            const myS = scores[mySocketId] !== undefined ? scores[mySocketId] : 0;
            let opS = 0;
            const opId = ids.find(id => id !== mySocketId);
            if (opId && scores[opId] !== undefined) {
                opS = scores[opId];
            }
            scMy.innerText = myS;
            scOp.innerText = opS;
        }

        function checkGameOver() {
            const remaining = document.querySelectorAll('#my-cards-container .card:not(.used)');
            if (remaining.length === 0) {
                setTimeout(() => {
                    // 엔딩 애니메이션 표시
                    endingOverlay.style.display = 'flex';
                    
                    // 배경에서는 카드 공개 (오버레이 걷히면 보이게)
                    const hiddenCards = document.querySelectorAll('.tracked-card.opponent-card');
                    hiddenCards.forEach(c => {
                        c.innerText = c.dataset.hiddenNum;
                        c.classList.remove('opponent-card');
                        c.style.color = c.classList.contains('black') ? 'white' : 'black';
                    });
                }, 1000);
            }
        }

        // [추가] 복기하기 버튼 클릭 시 실행
        function startReview() {
            endingOverlay.style.display = 'none'; // 어두운 화면 제거
            reviewControls.style.display = 'block'; // 하단 새 게임 버튼 표시
        }

        socket.on('update_score', (scores) => {
            if (!isLocked) {
                updateScore(scores);
            }
        });

        socket.on('full_room', alert);
        socket.on('player_left', () => location.reload());

    </script>
</body>
</html>